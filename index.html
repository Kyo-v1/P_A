<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ - AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { 
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #0a0a0f;
            color: #fff;
        }
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .dark-gradient {
            background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glow-border {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }
        .chat-bubble { 
            animation: slideUp 0.3s ease-out; 
        }
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        .message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .message-assistant {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .service-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .service-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }
        .service-card.connected {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.5);
        }
        input, textarea {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        input:focus, textarea:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #667eea;
            outline: none;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .logo-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }
        .scroll-smooth {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="dark-gradient">
    <div id="app"></div>

    <script>
        const N8N_WEBHOOK = 'https://n8n-n8n.pdvkjn.easypanel.host/webhook/P.A_Kyo';
        
        let currentScreen = 'signup';
        let user = null;
        let authMethod = null;
        let services = { google: false, microsoft: false, airtable: false, whatsapp: false };
        let messages = [];

        function generateId() {
            return 'client_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function render() {
            const app = document.getElementById('app');
            
            if (currentScreen === 'signup') {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="glass-effect glow-border rounded-3xl p-8 w-full max-w-md">
                            <div class="text-center mb-8">
                                <div class="logo-icon w-20 h-20 mx-auto mb-4">
                                    <span>ğŸ¤–</span>
                                </div>
                                <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h1>
                                <p class="text-gray-400">Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                                    <input type="text" id="name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" class="w-full px-4 py-3 rounded-xl transition-all" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                    <input type="email" id="email" placeholder="example@email.com" class="w-full px-4 py-3 rounded-xl transition-all" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                    <input type="password" id="password" placeholder="********" class="w-full px-4 py-3 rounded-xl transition-all" />
                                </div>
                                <button onclick="handleSignup()" class="w-full py-3 btn-primary text-white rounded-xl font-bold text-lg">
                                    Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
                                </button>
                            </div>
                            <p class="text-center text-sm text-gray-500 mt-6">
                                Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø£Ù†Øª ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ <span class="text-purple-400 cursor-pointer">Ø´Ø±ÙˆØ· Ø§Ù„Ø®Ø¯Ù…Ø©</span>
                            </p>
                        </div>
                    </div>
                `;
            } else if (currentScreen === 'auth') {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="glass-effect glow-border rounded-3xl p-8 w-full max-w-md">
                            <div class="text-center mb-8">
                                <div class="logo-icon w-20 h-20 mx-auto mb-4">
                                    <span>ğŸ¤–</span>
                                </div>
                                <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">Ø§Ø®ØªØ± Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯</h1>
                                <p class="text-gray-400">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.name}ØŒ Ø§Ø®ØªØ± Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…ÙØ¶Ù„ Ù„Ø¯ÙŠÙƒ</p>
                            </div>
                            <div class="space-y-4">
                                <button onclick="handleAuth('google')" class="w-full flex items-center justify-center gap-3 service-card hover:scale-105 rounded-xl p-4 transition-all">
                                    <svg class="w-8 h-8" viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                    <span class="font-semibold text-lg">Google Workspace</span>
                                </button>
                                <button onclick="handleAuth('microsoft')" class="w-full flex items-center justify-center gap-3 service-card hover:scale-105 rounded-xl p-4 transition-all">
                                    <svg class="w-8 h-8" viewBox="0 0 24 24">
                                        <path fill="#f25022" d="M1 1h10v10H1z"/>
                                        <path fill="#00a4ef" d="M13 1h10v10H13z"/>
                                        <path fill="#7fba00" d="M1 13h10v10H1z"/>
                                        <path fill="#ffb900" d="M13 13h10v10H13z"/>
                                    </svg>
                                    <span class="font-semibold text-lg">Microsoft 365</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentScreen === 'services') {
                app.innerHTML = `
                    <div class="min-h-screen p-4">
                        <div class="max-w-5xl mx-auto py-8">
                            <div class="glass-effect glow-border rounded-3xl p-8">
                                <div class="text-center mb-8">
                                    <h2 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">Ø±Ø¨Ø· Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h2>
                                    <p class="text-gray-400">Ù‚Ù… Ø¨Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨Ø§ØªÙƒ Ù„ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</p>
                                    <p class="text-sm text-gray-600 mt-2">Ù…Ø¹Ø±ÙÙƒ Ø§Ù„ÙØ±ÙŠØ¯: <span class="text-purple-400 font-mono">${user.id}</span></p>
                                </div>
                                <div class="grid md:grid-cols-2 gap-6 mb-8">
                                    ${authMethod ? `
                                    <div class="service-card ${services[authMethod] ? 'connected' : ''} rounded-2xl p-6">
                                        <div class="flex items-start justify-between mb-4">
                                            <div class="flex items-center gap-3">
                                                ${authMethod === 'google' ? `
                                                <svg class="w-12 h-12" viewBox="0 0 24 24">
                                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                                </svg>
                                                ` : `
                                                <svg class="w-12 h-12" viewBox="0 0 24 24">
                                                    <path fill="#f25022" d="M1 1h10v10H1z"/>
                                                    <path fill="#00a4ef" d="M13 1h10v10H13z"/>
                                                    <path fill="#7fba00" d="M1 13h10v10H1z"/>
                                                    <path fill="#ffb900" d="M13 13h10v10H13z"/>
                                                </svg>
                                                `}
                                                <div>
                                                    <h3 class="font-bold text-xl">${authMethod === 'google' ? 'Google Workspace' : 'Microsoft 365'}</h3>
                                                    <p class="text-sm text-gray-400">Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…ØŒ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</p>
                                                </div>
                                            </div>
                                            ${services[authMethod] ? '<span class="text-3xl">âœ…</span>' : ''}
                                        </div>
                                        <button onclick="connectService('${authMethod}')" ${services[authMethod] ? 'disabled' : ''} class="w-full py-3 rounded-xl font-semibold transition-all ${services[authMethod] ? 'bg-green-600 text-white cursor-not-allowed' : 'btn-primary text-white'}">
                                            ${services[authMethod] ? 'âœ“ Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­' : 'Ø±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù†'}
                                        </button>
                                    </div>
                                    ` : ''}
                                    <div class="service-card ${services.airtable ? 'connected' : ''} rounded-2xl p-6">
                                        <div class="flex items-start justify-between mb-4">
                                            <div class="flex items-center gap-3">
                                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjQ4IiByeD0iOCIgZmlsbD0iI0ZDQjQwMCIvPgo8cGF0aCBkPSJNMzAgMTVMMTggMjNMMzAgMzFWMTVaIiBmaWxsPSIjRkZGIi8+CjxwYXRoIGQ9Ik0xOCAyM0wzMCAzMUwxOCAzOVYyM1oiIGZpbGw9IiNGRkYiLz4KPHBhdGggZD0iTTE4IDE1TDMwIDIzTDE4IDMxVjE1WiIgZmlsbD0iI0ZGRiIvPgo8L3N2Zz4K" alt="Airtable" class="w-12 h-12 rounded-xl" />
                                                <div>
                                                    <h3 class="font-bold text-xl">Airtable</h3>
                                                    <p class="text-sm text-gray-400">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©</p>
                                                </div>
                                            </div>
                                            ${services.airtable ? '<span class="text-3xl">âœ…</span>' : ''}
                                        </div>
                                        <button onclick="connectService('airtable')" ${services.airtable ? 'disabled' : ''} class="w-full py-3 rounded-xl font-semibold transition-all ${services.airtable ? 'bg-green-600 text-white cursor-not-allowed' : 'bg-gradient-to-r from-yellow-500 to-orange-500 text-white hover:scale-105'}">
                                            ${services.airtable ? 'âœ“ Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­' : 'Ø±Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù†'}
                                        </button>
                                    </div>
                                    <div class="service-card rounded-2xl p-6 md:col-span-2">
                                        <div class="flex items-start justify-between mb-4">
                                            <div class="flex items-center gap-3">
                                                <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center">
                                                    <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <h3 class="font-bold text-xl">WhatsApp Business</h3>
                                                    <p class="text-sm text-gray-400">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§ØªØ³Ø§Ø¨</p>
                                                </div>
                                            </div>
                                            <span class="text-3xl">âš ï¸</span>
                                        </div>
                                        <button onclick="connectService('whatsapp')" class="w-full py-3 rounded-xl font-semibold bg-gradient-to-r from-green-500 to-green-600 text-white hover:scale-105 transition-all">
                                            ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù„Ù„Ø±Ø¨Ø·
                                        </button>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <button onclick="startChat()" class="px-12 py-4 btn-primary text-white rounded-xl font-bold text-lg inline-flex items-center gap-2">
                                        Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                                        </svg>
                                    </button>
                                    <p class="text-sm text-gray-500 mt-3">ÙŠØ¬Ø¨ Ø±Ø¨Ø· ${authMethod === 'google' ? 'Google' : 'Microsoft'} Ùˆ Airtable Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentScreen === 'chat') {
                const messagesHtml = messages.map(msg => `
                    <div class="flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'} chat-bubble">
                        <div class="max-w-2xl ${msg.type === 'user' ? 'message-user' : 'message-assistant'} rounded-2xl px-5 py-3 shadow-lg">
                            ${msg.isTyping ? `
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            ` : `
                                <p class="whitespace-pre-line text-sm leading-relaxed">${msg.content}</p>
                                <p class="text-xs mt-2 ${msg.type === 'user' ? 'text-white/70' : 'text-gray-400'}">${new Date(msg.timestamp).toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'})}</p>
                            `}
                        </div>
                    </div>
                `).join('');

                app.innerHTML = `
                    <div class="h-screen flex flex-col">
                        <div class="glass-effect border-b border-white/10 px-6 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="logo-icon w-12 h-12">
                                    <span class="text-xl">ğŸ¤–</span>
                                </div>
                                <div>
                                    <h1 class="font-bold text-lg">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h1>
                                    <p class="text-sm text-gray-400">Ù…ØªØµÙ„ â€¢ ${user.name}</p>
                                </div>
                            </div>
                            <button onclick="goToServices()" class="px-4 py-2 text-sm glass-effect hover:bg-white/10 rounded-lg transition-all">
                                Ø§Ù„Ø®Ø¯Ù…Ø§Øª
                            </button>
                        </div>
                        <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4 scroll-smooth">${messagesHtml}</div>
                        <div class="glass-effect border-t border-white/10 p-4">
                            <div class="flex items-center gap-3 max-w-4xl mx-auto">
                                <input type="file" id="fileInput" class="hidden" accept="image/*,.pdf,.doc,.docx" onchange="handleFile(event)" />
                                <button onclick="document.getElementById('fileInput').click()" class="p-3 glass-effect hover:bg-white/10 rounded-xl transition-all" title="Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù">
                                    ğŸ“
                                </button>
                                <button onclick="toggleRecording()" id="micBtn" class="p-3 glass-effect hover:bg-white/10 rounded-xl transition-all" title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ">
                                    ğŸ¤
                                </button>
                                <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." class="flex-1 px-4 py-3 rounded-xl transition-all" onkeypress="if(event.key==='Enter') sendMessage()" />
                                <button onclick="sendMessage()" class="p-3 btn-primary text-white rounded-xl transition-all" title="Ø¥Ø±Ø³Ø§Ù„">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    const messagesDiv = document.getElementById('messages');
                    if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }, 100);
            }
        }

        function handleSignup() {
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!name || !email || !password) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                return;
            }

            user = {
                id: generateId(),
                name: name,
                email: email,
                createdAt: new Date().toISOString()
            };

            currentScreen = 'auth';
            render();
        }

        function handleAuth(method) {
            authMethod = method;
            currentScreen = 'services';
            render();
        }

        function connectService(service) {
            if (service === 'whatsapp') {
                alert('Ù„Ù„Ø±Ø¨Ø· Ù…Ø¹ WhatsAppØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ù„Ù‰: +966 XX XXX XXXX');
                return;
            }

            // ÙØªØ­ Ù†Ø§ÙØ°Ø© OAuth
            const width = 600;
            const height = 700;
            const left = (screen.width / 2) - (width / 2);
            const top = (screen.height / 2) - (height / 2);
            
            const authUrls = {
                google: `/api/auth/google?user_id=${user.id}`,
                microsoft: `/api/auth/microsoft?user_id=${user.id}`,
                airtable: `/api/auth/airtable?user_id=${user.id}`
            };

            const authWindow = window.open(
                authUrls[service],
                'OAuth',
                `width=${width},height=${height},left=${left},top=${top}`
            );

            // Ø§Ø³ØªÙ…Ø¹ Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ù† Ù†Ø§ÙØ°Ø© OAuth
            window.addEventListener('message', function handler(event) {
                if (event.data.type === `${service}_connected`) {
                    services[service] = true;
                    render();
                    window.removeEventListener('message', handler);
                }
            });
        }

        function startChat() {
            const connected = Object.entries(services).filter(([key, val]) => val && key !== 'whatsapp').length;
            if (connected < 2) {
                alert('ÙŠØ±Ø¬Ù‰ Ø±Ø¨Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø®Ø¯Ù…ØªÙŠÙ† Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©');
                return;
            }

            messages = [{
                id: '1',
                type: 'assistant',
                content: `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.name}! ğŸ‘‹\n\nØ£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ… Ø¨ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©.\n\nÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:\n\nğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯\nğŸ“§ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ\nâœï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰\nğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©\nğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„\nğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ WhatsApp\nğŸ” Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©\n\nÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ`,
                timestamp: new Date()
            }];

            currentScreen = 'chat';
            render();
        }

        function goToServices() {
            currentScreen = 'services';
            render();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            messages.push({
                id: Date.now().toString(),
                type: 'user',
                content: message,
                timestamp: new Date()
            });

            input.value = '';
            render();

            const tempId = (Date.now() + 1).toString();
            messages.push({
                id: tempId,
                type: 'assistant',
                content: '',
                isTyping: true,
                timestamp: new Date()
            });
            render();

            const payload = {
                user_id: user.id,
                user_name: user.name,
                user_email: user.email,
                message: message,
                timestamp: new Date().toISOString()
            };

            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“¤ SENDING TO N8N');
            console.log('URL:', N8N_WEBHOOK);
            console.log('Payload:', JSON.stringify(payload, null, 2));
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            try {
                const response = await fetch(N8N_WEBHOOK, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ“¥ RESPONSE FROM N8N');
                console.log('Status:', response.status);
                console.log('Status Text:', response.statusText);
                console.log('OK:', response.ok);
                console.log('Headers:', [...response.headers.entries()]);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

                let reply = '';

                if (response.ok || response.status === 200) {
                    try {
                        const text = await response.text();
                        console.log('ğŸ“„ Raw Response:', text);
                        
                        if (!text || text.trim() === '') {
                            reply = 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­';
                        } else {
                            try {
                                const data = JSON.parse(text);
                                console.log('ğŸ“¦ Parsed JSON:', data);
                                
                                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø£ÙŠ Ù…Ø³ØªÙˆÙ‰ ÙÙŠ JSON
                                function extractText(obj) {
                                    if (typeof obj === 'string') {
                                        return obj;
                                    }
                                    
                                    if (Array.isArray(obj) && obj.length > 0) {
                                        return extractText(obj[0]);
                                    }
                                    
                                    if (typeof obj === 'object' && obj !== null) {
                                        // Ø¬Ø±Ø¨ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
                                        const keys = ['output', 'response', 'message', 'reply', 'text', 'content', 'result', 'answer'];
                                        for (const key of keys) {
                                            if (obj[key]) {
                                                const extracted = extractText(obj[key]);
                                                if (extracted) return extracted;
                                            }
                                        }
                                        
                                        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ØŒ Ø¬Ø±Ø¨ Ø£ÙˆÙ„ Ù‚ÙŠÙ…Ø©
                                        const values = Object.values(obj);
                                        if (values.length > 0) {
                                            return extractText(values[0]);
                                        }
                                    }
                                    
                                    return null;
                                }
                                
                                const extracted = extractText(data);
                                
                                if (extracted && extracted.trim()) {
                                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù…Ù† Ø±Ù…ÙˆØ² JSON Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
                                    let cleanedText = extracted;
                                    
                                    // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
                                    if (cleanedText.startsWith('"') && cleanedText.endsWith('"')) {
                                        cleanedText = cleanedText.slice(1, -1);
                                    }
                                    
                                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ­ÙŠØ· Ø¨Ø§Ù„Ù†Øµ
                                    if (cleanedText.startsWith('[') && cleanedText.endsWith(']')) {
                                        cleanedText = cleanedText.slice(1, -1).trim();
                                        if (cleanedText.startsWith('"')) {
                                            cleanedText = cleanedText.slice(1, -1);
                                        }
                                    }
                                    
                                    // ØªØ­ÙˆÙŠÙ„ escape sequences
                                    cleanedText = cleanedText
                                        .replace(/\\n/g, '\n')
                                        .replace(/\\t/g, '\t')
                                        .replace(/\\"/g, '"')
                                        .replace(/\\\\/g, '\\');
                                    
                                    reply = cleanedText;
                                } else {
                                    // Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø©: Ø¹Ø±Ø¶ JSON Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„
                                    reply = JSON.stringify(data, null, 2);
                                }
                            } catch (e) {
                                console.log('âš ï¸ Not JSON, using as text');
                                reply = text;
                            }
                        }
                    } catch (readError) {
                        console.error('âŒ Error reading response:', readError);
                        reply = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­';
                    }
                } else {
                    console.error('âš ï¸ Non-OK status:', response.status);
                    try {
                        const errorText = await response.text();
                        console.error('Error body:', errorText);
                    } catch (e) {
                        console.error('Could not read error:', e);
                    }
                    reply = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ ÙˆØ¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
                }

                console.log('âœ… Final reply:', reply);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

                messages = messages.map(msg => 
                    msg.id === tempId ? { ...msg, content: reply, isTyping: false } : msg
                );
                render();

            } catch (error) {
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.error('âŒ FETCH ERROR');
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Full error:', error);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

                let errorMsg = 'ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¢Ù†ØŒ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª...';

                messages = messages.map(msg => 
                    msg.id === tempId ? { ...msg, content: errorMsg, isTyping: false } : msg
                );
                render();
            }
        }

        let isRecording = false;
        function toggleRecording() {
            isRecording = !isRecording;
            const btn = document.getElementById('micBtn');
            if (isRecording) {
                btn.textContent = 'ğŸ”´';
                btn.classList.add('animate-pulse');
                setTimeout(() => {
                    toggleRecording();
                    document.getElementById('messageInput').value = 'Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ù†Øµ...';
                }, 3000);
            } else {
                btn.textContent = 'ğŸ¤';
                btn.classList.remove('animate-pulse');
            }
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (file) {
                alert(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù: ${file.name}`);
            }
        }

        render();
    </script>
</body>
</html>